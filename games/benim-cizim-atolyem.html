<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>âœ¨ Sihirli Ã‡izim AtÃ¶lyesi</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;800&display=swap');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LIGHT THEME TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:        #f7f5ff;
  --panel:     #ffffff;
  --panel2:    #f0eeff;
  --border:    #e8e3ff;
  --text:      #3d3560;
  --text-dim:  #a09cc0;
  --accent:    #7c5cbf;
  --accent2:   #f06292;
  --shadow:    rgba(100,80,200,.10);
  --radius:    13px;
}

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Nunito',sans-serif;background:var(--bg);touch-action:none;}

/* â•â•â•â•â•â•â• PORTRAIT BLOCKER â•â•â•â•â•â•â• */
#rotate-nudge{
  display:none;position:fixed;inset:0;z-index:9999;
  background:linear-gradient(135deg,#f06292,#9c64d8,#64b5f6);
  flex-direction:column;align-items:center;justify-content:center;gap:18px;
  text-align:center;padding:24px;
}
.rotate-icon{font-size:5rem;animation:tilt 1.1s ease-in-out infinite alternate;}
@keyframes tilt{from{transform:rotate(-22deg)}to{transform:rotate(22deg)}}
#rotate-nudge p{font-family:'Fredoka One',cursive;font-size:1.6rem;color:#fff;
  text-shadow:0 2px 10px rgba(0,0,0,.2);max-width:280px;}
#rotate-nudge small{font-size:.85rem;color:rgba(255,255,255,.8);font-weight:700;}

/* â•â•â•â•â•â•â• APP SHELL â•â•â•â•â•â•â• */
#app{display:flex;flex-direction:column;width:100%;height:100%;}

/* HEADER */
header{
  height:46px;min-height:46px;padding:0 14px;flex-shrink:0;z-index:20;
  background:#fff;
  border-bottom:2px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;gap:8px;
  box-shadow:0 2px 12px var(--shadow);
}
header h1{
  font-family:'Fredoka One',cursive;font-size:1.25rem;
  background:linear-gradient(90deg,#9c64d8,#f06292,#42a5f5);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  white-space:nowrap;letter-spacing:.3px;
}
#save-btn{
  background:linear-gradient(135deg,#9c64d8,#f06292);
  border:none;border-radius:10px;padding:6px 14px;
  font-family:'Fredoka One',cursive;font-size:.82rem;color:#fff;cursor:pointer;
  box-shadow:0 3px 12px rgba(156,100,216,.35);white-space:nowrap;
  transition:transform .15s,box-shadow .15s;
}
#save-btn:active{transform:scale(.93);}

/* MAIN */
main{flex:1;display:flex;overflow:hidden;min-height:0;}

/* SIDE PANELS */
.side-panel{
  width:78px;background:var(--panel);
  display:flex;flex-direction:column;align-items:center;
  padding:8px 5px;gap:8px;
  overflow-y:auto;overflow-x:hidden;flex-shrink:0;scrollbar-width:none;
  -webkit-overflow-scrolling:touch;
}
#left-panel {
  border-right:2px solid var(--border);
  touch-action:pan-y;        /* allow vertical finger scroll on this panel */
  overscroll-behavior:contain;
}
#right-panel{
  border-left:2px solid var(--border);
  touch-action:pan-y;
  overscroll-behavior:contain;
}
.side-panel::-webkit-scrollbar{display:none;}

/* Fade hint at bottom when panel overflows */
#left-panel::after{
  content:'';
  position:sticky;bottom:0;
  display:block;width:100%;height:22px;flex-shrink:0;
  background:linear-gradient(to bottom,transparent,var(--panel));
  pointer-events:none;
}

.panel-label{
  font-size:.5rem;font-weight:800;color:var(--text-dim);
  text-transform:uppercase;letter-spacing:.9px;text-align:center;
}
.sep{width:42px;height:2px;background:var(--border);border-radius:2px;flex-shrink:0;}

/* BRUSH BUTTONS */
.brush-group{display:flex;flex-direction:column;gap:5px;align-items:center;width:100%;}
.brush-btn{
  width:58px;height:38px;border:2px solid var(--border);border-radius:11px;
  background:var(--panel2);cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all .18s;flex-shrink:0;
}
.brush-btn::before{content:'';border-radius:50%;background:var(--text-dim);transition:all .18s;}
.brush-btn.sz-thin::before {width:3px; height:3px;}
.brush-btn.sz-mid::before  {width:9px; height:9px;}
.brush-btn.sz-thick::before{width:19px;height:19px;}
.brush-btn.active{
  border-color:var(--accent2);background:#fff0f6;
  box-shadow:0 2px 10px rgba(240,98,146,.25);
}
.brush-btn.active::before{background:var(--accent2);}
.brush-btn:active{transform:scale(.9);}

/* TOOL BUTTONS */
.tool-btn{
  width:58px;height:42px;border:2px solid var(--border);border-radius:11px;
  background:var(--panel2);cursor:pointer;font-size:1.3rem;
  display:flex;align-items:center;justify-content:center;
  transition:all .18s;flex-shrink:0;position:relative;
}
.tool-btn:active{transform:scale(.9);}
.tool-btn.active{
  border-color:var(--accent);background:#ede8ff;
  box-shadow:0 2px 10px rgba(124,92,191,.25);
}
.tool-btn.magic.active{
  border-color:#f9a825;background:#fff8e1;
  box-shadow:0 2px 12px rgba(249,168,37,.3);
}
.tool-btn.stamp-active{
  border-color:#43a047;background:#e8f5e9;
  box-shadow:0 2px 10px rgba(67,160,71,.25);
}
.tool-btn.danger{border-color:#ffccbc;}
.tool-btn.danger:active{background:#fff3e0;}
.tool-btn:disabled{opacity:.35;cursor:not-allowed;transform:none!important;}

/* MAGIC BADGE */
.magic-badge{
  position:absolute;top:-5px;right:-5px;width:14px;height:14px;
  border-radius:50%;font-size:.5rem;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#ffd600,#f06292,#42a5f5);
  animation:spin 2.5s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg);}}

/* STAMP PICKER */
#stamp-picker{display:none;flex-wrap:wrap;gap:3px;justify-content:center;width:100%;}
#stamp-picker.open{display:flex;}
.stamp-opt{
  font-size:1.3rem;cursor:pointer;width:28px;height:28px;
  display:flex;align-items:center;justify-content:center;
  border-radius:8px;border:2px solid transparent;transition:all .15s;
  background:var(--panel2);
}
.stamp-opt.active{border-color:#43a047;background:#e8f5e9;}
.stamp-opt:active{transform:scale(1.25);}

/* TEMPLATE PICKER */
#template-picker{display:none;flex-direction:column;gap:4px;align-items:center;width:100%;}
#template-picker.open{display:flex;}
.tmpl-btn{
  width:54px;height:28px;font-size:.58rem;font-weight:800;cursor:pointer;
  border-radius:8px;border:2px solid var(--border);
  background:var(--panel2);color:var(--text-dim);
  transition:all .15s;display:flex;align-items:center;justify-content:center;gap:2px;
}
.tmpl-btn:active{transform:scale(.93);}
.tmpl-btn.active{border-color:var(--accent);color:var(--accent);background:#ede8ff;}

/* PALETTE */
.palette{display:grid;grid-template-columns:1fr 1fr;gap:5px;}
.color-dot{
  width:26px;height:26px;border-radius:50%;cursor:pointer;
  border:2px solid transparent;transition:all .18s;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
}
.color-dot:active{transform:scale(1.2);}
.color-dot.active{
  border-color:var(--text);transform:scale(1.2);
  box-shadow:0 3px 10px rgba(0,0,0,.25);
}

/* CUSTOM COLOR */
.custom-color-wrap{
  position:relative;width:58px;height:32px;border-radius:9px;overflow:hidden;
  border:2px solid var(--border);cursor:pointer;flex-shrink:0;
}
.custom-color-wrap input[type=color]{
  position:absolute;inset:-8px;width:calc(100% + 16px);height:calc(100% + 16px);
  border:none;padding:0;cursor:pointer;opacity:.01;
}
.custom-color-preview{
  width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:.95rem;
  background:linear-gradient(135deg,#f06292,#ffd600,#42a5f5,#9c64d8);
}

/* â•â•â•â•â•â•â• CANVAS â•â•â•â•â•â•â• */
#canvas-wrapper{
  flex:1;position:relative;overflow:hidden;min-width:0;
  background:#ffffff;
}
/* Subtle dot grid on white */
#canvas-wrapper::before{
  content:'';position:absolute;inset:0;pointer-events:none;z-index:0;
  background-image:radial-gradient(circle,#d8d0f0 1px,transparent 1px);
  background-size:22px 22px;
  opacity:.5;
}
#main-canvas{position:absolute;top:0;left:0;cursor:crosshair;touch-action:none;z-index:1;}
#fx-canvas  {position:absolute;top:0;left:0;pointer-events:none;z-index:2;}

/* â•â•â•â•â•â•â• EMOTION BAR â•â•â•â•â•â•â• */
#emotion-bar{
  position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
  background:rgba(255,255,255,.94);backdrop-filter:blur(10px);
  border-radius:26px;padding:5px 12px;
  display:flex;align-items:center;gap:5px;
  box-shadow:0 4px 20px rgba(124,92,191,.18);
  border:2px solid var(--border);z-index:50;white-space:nowrap;
}
.emo-label{
  font-size:.52rem;font-weight:800;color:var(--text-dim);
  text-transform:uppercase;letter-spacing:.7px;
}
.emotion-btn{
  border:none;background:none;font-size:1.35rem;cursor:pointer;
  width:38px;height:38px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  transition:transform .18s;flex-shrink:0;
}
.emotion-btn:active{transform:scale(1.35) rotate(-8deg);}

/* â•â•â•â•â•â•â• FLOAT SAVE â•â•â•â•â•â•â• */
#save-btn-float{
  display:none;position:absolute;top:8px;right:8px;z-index:60;
  background:linear-gradient(135deg,#9c64d8,#f06292);
  border:none;border-radius:10px;padding:5px 11px;
  font-family:'Fredoka One',cursive;font-size:.75rem;color:#fff;cursor:pointer;
  box-shadow:0 3px 12px rgba(156,100,216,.35);transition:transform .15s;
}
#save-btn-float:active{transform:scale(.93);}

/* â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â• */
#toast{
  position:fixed;top:10px;left:50%;transform:translateX(-50%);
  background:var(--text);color:#fff;padding:7px 18px;
  border-radius:20px;font-size:.78rem;font-weight:700;
  opacity:0;pointer-events:none;transition:opacity .3s;
  z-index:9999;white-space:nowrap;max-width:86vw;
  box-shadow:0 4px 16px rgba(61,53,96,.25);
}
#toast.show{opacity:1;}

/* â•â•â•â•â•â•â• CONFIRM DIALOG â•â•â•â•â•â•â• */
#confirm-overlay{
  display:none;position:fixed;inset:0;z-index:10000;
  background:rgba(61,53,96,.45);backdrop-filter:blur(4px);
  align-items:center;justify-content:center;
}
#confirm-overlay.show{ display:flex; }
#confirm-box{
  background:#fff;border-radius:22px;padding:28px 24px 20px;
  text-align:center;max-width:280px;width:88%;
  box-shadow:0 12px 40px rgba(61,53,96,.25);
  animation:pop-in .22s cubic-bezier(.34,1.56,.64,1) forwards;
}
@keyframes pop-in{
  from{transform:scale(.7);opacity:0}
  to  {transform:scale(1);opacity:1}
}
#confirm-icon{ font-size:2.8rem; margin-bottom:10px; }
#confirm-msg{
  font-family:'Nunito',sans-serif;font-size:1rem;font-weight:800;
  color:var(--text);line-height:1.4;margin-bottom:18px;
}
#confirm-btns{ display:flex;gap:10px;justify-content:center; }
#confirm-yes{
  background:linear-gradient(135deg,#e53935,#f06292);
  border:none;border-radius:12px;padding:10px 22px;
  font-family:'Fredoka One',cursive;font-size:.95rem;color:#fff;
  cursor:pointer;box-shadow:0 3px 12px rgba(229,57,53,.3);
  transition:transform .15s;
}
#confirm-yes:active{ transform:scale(.93); }
#confirm-no{
  background:var(--panel2);border:2px solid var(--border);
  border-radius:12px;padding:10px 22px;
  font-family:'Fredoka One',cursive;font-size:.95rem;color:var(--text);
  cursor:pointer;transition:transform .15s;
}
#confirm-no:active{ transform:scale(.93); }

@keyframes bounce{
  0%{transform:scale(1)}
  30%{transform:scale(1.28)}
  55%{transform:scale(.92)}
  75%{transform:scale(1.1)}
  100%{transform:scale(1)}
}
.bounce{animation:bounce .38s ease forwards;}

/* â•â•â•â•â•â•â• MOBILE LANDSCAPE â•â•â•â•â•â•â• */
@media (max-height:480px) and (orientation:landscape){
  header{display:none;}
  #save-btn-float{display:flex!important;}
  .side-panel{width:60px;padding:5px 3px;gap:5px;}
  .brush-btn{width:46px;height:30px;}
  .brush-btn.sz-thick::before{width:15px;height:15px;}
  .tool-btn{width:46px;height:34px;font-size:1.05rem;}
  .color-dot{width:21px;height:21px;}
  .palette{gap:4px;}
  .custom-color-wrap{width:46px;height:26px;}
  .sep{width:34px;}
  .panel-label{font-size:.44rem;}
  #emotion-bar{padding:4px 9px;gap:4px;bottom:5px;border-radius:18px;}
  .emotion-btn{width:32px;height:32px;font-size:1.1rem;}
  .emo-label{display:none;}
  .stamp-opt{width:23px;height:23px;font-size:1.1rem;}
  .tmpl-btn{width:46px;font-size:.54rem;}
  .magic-badge{width:11px;height:11px;font-size:.38rem;top:-4px;right:-4px;}
}
/* Tablet/desktop */
@media (min-width:768px){
  .side-panel{width:86px;}
  .brush-btn{width:64px;height:42px;}
  .tool-btn{width:64px;height:46px;font-size:1.4rem;}
  .color-dot{width:29px;height:29px;}
  .custom-color-wrap{width:64px;height:36px;}
  .stamp-opt{width:30px;height:30px;font-size:1.5rem;}
  #emotion-bar{bottom:14px;}
  .emotion-btn{width:42px;height:42px;font-size:1.45rem;}
}
</style>
</head>
<body>

<!-- Portrait blocker -->
<div id="rotate-nudge">
  <div class="rotate-icon">ğŸ“±</div>
  <p>Telefonu yan Ã§evir, sihir baÅŸlasÄ±n!</p>
  <small>Yatay mod Ã§ok daha eÄŸlenceli âœ¨</small>
</div>

<div id="app">
  <header>
    <h1>âœ¨ Sihirli Ã‡izim AtÃ¶lyesi</h1>
    <button id="save-btn">ğŸ’¾ Resmimi Sakla!</button>
  </header>

  <main>
    <!-- LEFT PANEL -->
    <div class="side-panel" id="left-panel">
      <span class="panel-label">FÄ±rÃ§a</span>
      <div class="brush-group">
        <button class="brush-btn sz-thin"       data-size="4"  title="Ä°nce fÄ±rÃ§a"></button>
        <button class="brush-btn sz-mid active" data-size="12" title="Orta fÄ±rÃ§a"></button>
        <button class="brush-btn sz-thick"      data-size="28" title="KalÄ±n fÄ±rÃ§a"></button>
      </div>

      <div class="sep"></div>
      <span class="panel-label">AraÃ§</span>
      <button class="tool-btn active" id="btn-brush"  title="FÄ±rÃ§a">ğŸ–Œï¸</button>
      <button class="tool-btn magic"  id="btn-magic"  title="GÃ¶kkuÅŸaÄŸÄ± FÄ±rÃ§asÄ±">
        ğŸŒˆ<div class="magic-badge">âœ¦</div>
      </button>
      <button class="tool-btn"        id="btn-stamp"  title="Emoji Damga">ğŸ¯</button>
      <button class="tool-btn"        id="btn-eraser" title="Silgi">ğŸ§¹</button>

      <div class="sep"></div>
      <span class="panel-label">Åablon</span>
      <button class="tool-btn" id="btn-template" title="Åablon SeÃ§">ğŸ“‹</button>
      <div id="template-picker">
        <button class="tmpl-btn" data-tmpl="cat">ğŸ± Kedi</button>
        <button class="tmpl-btn" data-tmpl="rocket">ğŸš€ Roket</button>
        <button class="tmpl-btn" data-tmpl="house">ğŸ  Ev</button>
        <button class="tmpl-btn" data-tmpl="none">âœ– KaldÄ±r</button>
      </div>

      <div class="sep"></div>
      <button class="tool-btn" id="btn-undo" title="Geri Al">â†©ï¸</button>
      <button class="tool-btn danger" id="btn-clear" title="TÃ¼mÃ¼nÃ¼ Sil">ğŸ—‘ï¸</button>
    </div>

    <!-- CANVAS -->
    <div id="canvas-wrapper">
      <canvas id="main-canvas"></canvas>
      <canvas id="fx-canvas"></canvas>
      <button id="save-btn-float">ğŸ’¾ Sakla</button>
      <div id="emotion-bar">
        <span class="emo-label">Duygu â†’</span>
        <button class="emotion-btn" data-color="#f9a825" data-label="Mutlu"     title="Mutlu">ğŸ˜Š</button>
        <button class="emotion-btn" data-color="#42a5f5" data-label="DÃ¼ÅŸÃ¼nceli" title="DÃ¼ÅŸÃ¼nceli">ğŸ¤”</button>
        <button class="emotion-btn" data-color="#f06292" data-label="HeyecanlÄ±" title="HeyecanlÄ±">ğŸ¤©</button>
        <button class="emotion-btn" data-color="#66bb6a" data-label="Sakin"     title="Sakin">ğŸ˜Œ</button>
        <button class="emotion-btn" data-color="#9c64d8" data-label="Gizemli"   title="Gizemli">ğŸ”®</button>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="side-panel" id="right-panel">
      <span class="panel-label">Renk</span>
      <div class="palette" id="palette"></div>

      <div class="sep"></div>
      <span class="panel-label">Ã–zel</span>
      <div class="custom-color-wrap" title="Ã–zel Renk SeÃ§">
        <div class="custom-color-preview">âœ¨</div>
        <input type="color" id="custom-color" value="#9c64d8">
      </div>

      <div class="sep"></div>
      <span class="panel-label">Damga</span>
      <div id="stamp-picker">
        <div class="stamp-opt active" data-emoji="ğŸ¦„">ğŸ¦„</div>
        <div class="stamp-opt" data-emoji="â­">â­</div>
        <div class="stamp-opt" data-emoji="ğŸ¨">ğŸ¨</div>
        <div class="stamp-opt" data-emoji="ğŸ¾">ğŸ¾</div>
        <div class="stamp-opt" data-emoji="ğŸŒˆ">ğŸŒˆ</div>
        <div class="stamp-opt" data-emoji="ğŸ”¥">ğŸ”¥</div>
        <div class="stamp-opt" data-emoji="ğŸ’">ğŸ’</div>
        <div class="stamp-opt" data-emoji="ğŸš€">ğŸš€</div>
      </div>
    </div>
  </main>
</div>

<div id="confirm-overlay">
  <div id="confirm-box">
    <div id="confirm-icon">ğŸ—‘ï¸</div>
    <p id="confirm-msg"></p>
    <div id="confirm-btns">
      <button id="confirm-yes">Evet, sil!</button>
      <button id="confirm-no">HayÄ±r, dur!</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   1. ALL STATE â€” declared first, no TDZ errors
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var currentMode    = 'brush';   // 'brush' | 'magic' | 'stamp' | 'eraser'
var brushSize      = 12;
var isDrawing      = false;
var lastX          = 0;
var lastY          = 0;
var rainbowHue     = 0;
var brushThrottle  = 0;
var activeTemplate = null;      // null | 'cat' | 'rocket' | 'house'
var selectedStamp  = 'ğŸ¦„';
var currentColor   = '#e53935';
var undoStack      = [];
var MAX_UNDO       = 20;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   2. AUDIO ENGINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var audioCtx   = null;
var audioReady = false;

function initAudio() {
  if (audioCtx) return;
  try {
    audioCtx   = new (window.AudioContext || window.webkitAudioContext)();
    audioReady = true;
  } catch(e) {}
}
document.addEventListener('pointerdown', initAudio, { once: true });
document.addEventListener('touchstart',  initAudio, { once: true });

function playTone(freq, type, dur, vol, delay) {
  vol   = vol   || 0.14;
  delay = delay || 0;
  if (!audioReady) return;
  var t    = audioCtx.currentTime + delay;
  var osc  = audioCtx.createOscillator();
  var gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.type = type;
  osc.frequency.setValueAtTime(freq, t);
  gain.gain.setValueAtTime(0, t);
  gain.gain.linearRampToValueAtTime(vol, t + 0.01);
  gain.gain.exponentialRampToValueAtTime(0.001, t + dur);
  osc.start(t);
  osc.stop(t + dur);
}

function playBrush() {
  if (!audioReady) return;
  var t    = audioCtx.currentTime;
  var osc  = audioCtx.createOscillator();
  var gain = audioCtx.createGain();
  var freq = 520 + Math.random() * 180;   // soft mid-range tone
  osc.type = 'sine';
  osc.frequency.setValueAtTime(freq, t);
  osc.frequency.exponentialRampToValueAtTime(freq * 0.85, t + 0.08);
  gain.gain.setValueAtTime(0, t);
  gain.gain.linearRampToValueAtTime(0.06, t + 0.01);
  gain.gain.exponentialRampToValueAtTime(0.001, t + 0.09);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start(t);
  osc.stop(t + 0.1);
}

function playStamp()   { playTone(520,'sine',0.12,0.22); playTone(780,'sine',0.09,0.18,0.06); }
function playEraser()  { playTone(180,'sawtooth',0.08,0.12); playTone(120,'sawtooth',0.06,0.1,0.05); }
function playSuccess() { [523,659,784,1047].forEach(function(f,i){ playTone(f,'sine',0.18,0.18,i*0.09); }); }
function playMagic()   { playTone(880 + Math.random()*440,'sine',0.07,0.11); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   3. ORIENTATION GUARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var nudge = document.getElementById('rotate-nudge');
var appEl = document.getElementById('app');

function checkOri() {
  var landscape = window.innerWidth > window.innerHeight;
  var mobile    = window.innerWidth < 1024 || ('ontouchstart' in window);
  nudge.style.display       = (mobile && !landscape) ? 'flex' : 'none';
  appEl.style.visibility    = (mobile && !landscape) ? 'hidden' : 'visible';
}
checkOri();
window.addEventListener('resize', checkOri);
window.addEventListener('orientationchange', function(){ setTimeout(checkOri, 200); });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   4. CANVAS â€” setup before any draw calls
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var canvas  = document.getElementById('main-canvas');
var ctx     = canvas.getContext('2d');
var fxCvs   = document.getElementById('fx-canvas');
var fxCtx   = fxCvs.getContext('2d');
var wrapper = document.getElementById('canvas-wrapper');

function resizeCanvas() {
  var tmp = document.createElement('canvas');
  tmp.width  = canvas.width;
  tmp.height = canvas.height;
  tmp.getContext('2d').drawImage(canvas, 0, 0);

  canvas.width  = fxCvs.width  = wrapper.clientWidth;
  canvas.height = fxCvs.height = wrapper.clientHeight;

  /* White background */
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  if (tmp.width > 0 && tmp.height > 0) ctx.drawImage(tmp, 0, 0);

  /* Re-stamp active template */
  if (activeTemplate) drawTemplate(activeTemplate);
}

/* Call after state is declared â€” safe now */
resizeCanvas();
window.addEventListener('resize',              function(){ setTimeout(resizeCanvas, 120); });
window.addEventListener('orientationchange',   function(){ setTimeout(resizeCanvas, 320); });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   5. PALETTE  (vivid but not neon)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var COLORS = [
  '#e53935','#f06292','#fb8c00','#fdd835',
  '#43a047','#26c6da','#1e88e5','#9c64d8',
  '#795548','#546e7a','#ec407a','#00897b'
];

var paletteEl = document.getElementById('palette');

COLORS.forEach(function(c) {
  var d = document.createElement('div');
  d.className   = 'color-dot' + (c === currentColor ? ' active' : '');
  d.style.background = c;
  d.addEventListener('click', function(){ pickColor(c, d); });
  paletteEl.appendChild(d);
});

function pickColor(c, dotEl) {
  currentColor = c;
  currentMode  = 'brush';
  syncToolUI();
  document.querySelectorAll('.color-dot').forEach(function(d){ d.classList.remove('active'); });
  if (dotEl) dotEl.classList.add('active');
}

document.getElementById('custom-color').addEventListener('input', function(e) {
  document.querySelectorAll('.color-dot').forEach(function(d){ d.classList.remove('active'); });
  pickColor(e.target.value, null);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   6. UI SYNC â€” references buttons after DOM ready
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var btnBrush    = document.getElementById('btn-brush');
var btnMagic    = document.getElementById('btn-magic');
var btnStamp    = document.getElementById('btn-stamp');
var btnEraser   = document.getElementById('btn-eraser');
var btnTemplate = document.getElementById('btn-template');
var btnClear    = document.getElementById('btn-clear');
var stampPick   = document.getElementById('stamp-picker');
var tmplPick    = document.getElementById('template-picker');

function syncToolUI() {
  [btnBrush, btnMagic, btnStamp, btnEraser].forEach(function(b){
    b.classList.remove('active','stamp-active');
  });
  stampPick.classList.remove('open');

  switch (currentMode) {
    case 'brush':  btnBrush.classList.add('active');  break;
    case 'magic':  btnMagic.classList.add('active');  break;
    case 'stamp':
      btnStamp.classList.add('active','stamp-active');
      stampPick.classList.add('open');
      break;
    case 'eraser': btnEraser.classList.add('active'); break;
  }
  canvas.style.cursor = currentMode === 'stamp' ? 'cell' : 'crosshair';
}

/* Brush size buttons */
document.querySelectorAll('.brush-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.brush-btn').forEach(function(b){ b.classList.remove('active'); });
    btn.classList.add('active');
    brushSize = parseInt(btn.dataset.size, 10);
    bounce(btn);
  });
});

/* Tool buttons */
btnBrush.addEventListener('click', function() {
  currentMode = 'brush';
  syncToolUI();
  bounce(btnBrush);
});
btnMagic.addEventListener('click', function() {
  currentMode = 'magic';
  syncToolUI();
  bounce(btnMagic);
  toast('ğŸŒˆ GÃ¶kkuÅŸaÄŸÄ± Modu aÃ§Ä±k! Ã‡iz ve sihri gÃ¶r!');
});
btnEraser.addEventListener('click', function() {
  currentMode = 'eraser';
  syncToolUI();
  bounce(btnEraser);
  playEraser();
});
btnStamp.addEventListener('click', function() {
  currentMode = currentMode === 'stamp' ? 'brush' : 'stamp';
  syncToolUI();
  bounce(btnStamp);
  if (currentMode === 'stamp') toast('ğŸ¯ Damga modu! Tuvale dokun!');
});

/* Stamp selection */
document.querySelectorAll('.stamp-opt').forEach(function(opt) {
  opt.addEventListener('click', function() {
    document.querySelectorAll('.stamp-opt').forEach(function(o){ o.classList.remove('active'); });
    opt.classList.add('active');
    selectedStamp = opt.dataset.emoji;
    currentMode   = 'stamp';
    syncToolUI();
  });
});

/* Template picker toggle */
btnTemplate.addEventListener('click', function() {
  var open = tmplPick.classList.toggle('open');
  bounce(btnTemplate);
  btnTemplate.classList.toggle('active', open);
});

document.querySelectorAll('.tmpl-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.tmpl-btn').forEach(function(b){ b.classList.remove('active'); });
    btn.classList.add('active');
    var t = btn.dataset.tmpl;
    if (t === 'none') {
      activeTemplate = null;
      /* Redraw canvas without template: clear and restore user drawing */
      redrawWithoutTemplate();
    } else {
      activeTemplate = t;
      drawTemplate(t);
    }
    tmplPick.classList.remove('open');
    btnTemplate.classList.remove('active');
    bounce(btn);
    toast(t === 'none' ? 'âœ– Åablon kaldÄ±rÄ±ldÄ±' : 'ğŸ“‹ Åablon yÃ¼klendi! Boyamaya baÅŸla!');
  });
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   7. TEMPLATE DRAWING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* Store user drawing separately so we can re-composite */
var userSnapshot = null;

function snapshotUser() {
  userSnapshot = document.createElement('canvas');
  userSnapshot.width  = canvas.width;
  userSnapshot.height = canvas.height;
  userSnapshot.getContext('2d').drawImage(canvas, 0, 0);
}

function redrawWithoutTemplate() {
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  if (userSnapshot) ctx.drawImage(userSnapshot, 0, 0);
}

function drawTemplate(name) {
  var w  = canvas.width, h = canvas.height;
  var cx = w / 2,        cy = h / 2;
  var s  = Math.min(w, h) * 0.40;

  ctx.save();
  ctx.globalAlpha   = 0.20;
  ctx.strokeStyle   = '#9c64d8';
  ctx.lineWidth     = 2.5;
  ctx.lineCap       = 'round';
  ctx.lineJoin      = 'round';
  ctx.setLineDash([8, 6]);

  if (name === 'cat')    drawCat(cx, cy, s);
  if (name === 'rocket') drawRocket(cx, cy, s);
  if (name === 'house')  drawHouse(cx, cy, s);

  ctx.restore();
}

function drawCat(cx, cy, s) {
  var r = s * 0.45;
  // Body
  ctx.beginPath(); ctx.arc(cx, cy + r*0.1, r, 0, Math.PI*2); ctx.stroke();
  // Head
  ctx.beginPath(); ctx.arc(cx, cy - r*1.0, r*0.55, 0, Math.PI*2); ctx.stroke();
  // Ears
  ctx.beginPath();
  ctx.moveTo(cx - r*0.35, cy - r*1.42); ctx.lineTo(cx - r*0.55, cy - r*1.78); ctx.lineTo(cx - r*0.1, cy - r*1.44);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(cx + r*0.35, cy - r*1.42); ctx.lineTo(cx + r*0.55, cy - r*1.78); ctx.lineTo(cx + r*0.1, cy - r*1.44);
  ctx.stroke();
  // Eyes
  ctx.beginPath(); ctx.arc(cx - r*0.2, cy - r*1.05, r*0.07, 0, Math.PI*2); ctx.stroke();
  ctx.beginPath(); ctx.arc(cx + r*0.2, cy - r*1.05, r*0.07, 0, Math.PI*2); ctx.stroke();
  // Nose
  ctx.beginPath(); ctx.arc(cx, cy - r*0.9, r*0.045, 0, Math.PI*2); ctx.stroke();
  // Whiskers
  ctx.beginPath(); ctx.moveTo(cx - r*0.05, cy - r*0.9); ctx.lineTo(cx - r*0.52, cy - r*0.86); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx + r*0.05, cy - r*0.9); ctx.lineTo(cx + r*0.52, cy - r*0.86); ctx.stroke();
  // Tail
  ctx.beginPath();
  ctx.moveTo(cx + r, cy + r*0.3);
  ctx.bezierCurveTo(cx + r*1.5, cy + r*0.6, cx + r*1.4, cy - r*0.2, cx + r*0.9, cy - r*0.3);
  ctx.stroke();
}

function drawRocket(cx, cy, s) {
  var h  = s * 1.1, hw = s * 0.32;
  var top = cy - h*0.55, bot = cy + h*0.45;
  // Body
  ctx.beginPath();
  ctx.moveTo(cx, top);
  ctx.bezierCurveTo(cx+hw, top+h*0.1, cx+hw, bot-h*0.25, cx+hw*0.6, bot);
  ctx.lineTo(cx-hw*0.6, bot);
  ctx.bezierCurveTo(cx-hw, bot-h*0.25, cx-hw, top+h*0.1, cx, top);
  ctx.stroke();
  // Window
  ctx.beginPath(); ctx.arc(cx, cy - h*0.08, hw*0.4, 0, Math.PI*2); ctx.stroke();
  // Fins
  ctx.beginPath(); ctx.moveTo(cx-hw*0.6,bot-h*0.05); ctx.lineTo(cx-hw*1.1,bot+h*0.07); ctx.lineTo(cx-hw*0.3,bot); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx+hw*0.6,bot-h*0.05); ctx.lineTo(cx+hw*1.1,bot+h*0.07); ctx.lineTo(cx+hw*0.3,bot); ctx.stroke();
  // Flame
  ctx.beginPath();
  ctx.moveTo(cx-hw*0.3,bot);
  ctx.bezierCurveTo(cx-hw*0.2,bot+h*0.15, cx,bot+h*0.22, cx,bot+h*0.25);
  ctx.bezierCurveTo(cx,bot+h*0.22, cx+hw*0.2,bot+h*0.15, cx+hw*0.3,bot);
  ctx.stroke();
}

function drawHouse(cx, cy, s) {
  var hw = s*0.55, hh = s*0.4;
  var roofTop = cy - hh - s*0.38, floorBot = cy + hh;
  // Walls
  ctx.beginPath(); ctx.rect(cx-hw, cy-hh, hw*2, hh*2); ctx.stroke();
  // Roof
  ctx.beginPath(); ctx.moveTo(cx-hw-s*0.06,cy-hh); ctx.lineTo(cx,roofTop); ctx.lineTo(cx+hw+s*0.06,cy-hh); ctx.stroke();
  // Door
  var dw=hw*0.32,dh=hh*0.55;
  ctx.beginPath(); ctx.rect(cx-dw, floorBot-dh, dw*2, dh); ctx.stroke();
  ctx.beginPath(); ctx.arc(cx+dw*0.5, floorBot-dh*0.42, 4, 0, Math.PI*2); ctx.stroke();
  // Windows
  ctx.beginPath(); ctx.rect(cx-hw*0.78, cy-hh*0.55, hw*0.32, hh*0.38); ctx.stroke();
  ctx.beginPath(); ctx.rect(cx+hw*0.46, cy-hh*0.55, hw*0.32, hh*0.38); ctx.stroke();
  // Chimney
  ctx.beginPath();
  ctx.moveTo(cx+hw*0.45, roofTop+s*0.12); ctx.lineTo(cx+hw*0.45, roofTop-s*0.18);
  ctx.lineTo(cx+hw*0.68, roofTop-s*0.18); ctx.lineTo(cx+hw*0.68, roofTop+s*0.22);
  ctx.stroke();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIRM DIALOG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var confirmOverlay = document.getElementById('confirm-overlay');
var confirmMsg     = document.getElementById('confirm-msg');
var confirmYes     = document.getElementById('confirm-yes');
var confirmNo      = document.getElementById('confirm-no');
var confirmCb      = null;

function showConfirm(msg, onYes) {
  confirmMsg.textContent = msg;
  confirmCb = onYes;
  confirmOverlay.classList.add('show');
}

confirmYes.addEventListener('click', function() {
  confirmOverlay.classList.remove('show');
  if (confirmCb) { confirmCb(); confirmCb = null; }
});
confirmNo.addEventListener('click', function() {
  confirmOverlay.classList.remove('show');
  confirmCb = null;
  toast('ğŸ‘ Ä°yi ki sormuÅŸum!');
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   8. CLEAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
btnClear.addEventListener('click', function() {
  showConfirm('ğŸ—‘ï¸ TÃ¼m Ã§izimi silmek istiyor musun?', function() {
    saveUndoSnapshot();
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    userSnapshot = null;
    if (activeTemplate) drawTemplate(activeTemplate);
    playSuccess();
    launchConfetti();
    toast('ğŸ‰ Tuval temizlendi! Yeni bir ÅŸaheser zamanÄ±!');
    bounce(btnClear);
  });
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   8b. UNDO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var btnUndo = document.getElementById('btn-undo');
btnUndo.disabled = true;

function saveUndoSnapshot() {
  undoStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
  if (undoStack.length > MAX_UNDO) undoStack.shift();
  btnUndo.disabled = false;
}

function undo() {
  if (undoStack.length === 0) return;
  var snap = undoStack.pop();
  ctx.putImageData(snap, 0, 0);
  if (undoStack.length === 0) btnUndo.disabled = true;
  playTone(440, 'sine', 0.12, 0.1);
  toast('â†©ï¸ Geri alÄ±ndÄ±!');
}

btnUndo.addEventListener('click', function() {
  undo();
  bounce(btnUndo);
});

/* Keyboard shortcut: Ctrl+Z / Cmd+Z */
document.addEventListener('keydown', function(e) {
  if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
    e.preventDefault();
    undo();
  }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   9. DRAW EVENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getPos(e) {
  var r = canvas.getBoundingClientRect();
  var s = e.touches ? e.touches[0] : e;
  return {
    x: (s.clientX - r.left) * (canvas.width  / r.width),
    y: (s.clientY - r.top)  * (canvas.height / r.height)
  };
}

function startDraw(e) {
  e.preventDefault();
  initAudio();
  isDrawing = true;
  var p = getPos(e);
  lastX = p.x; lastY = p.y;

  /* Snapshot BEFORE this stroke so we can undo it */
  saveUndoSnapshot();

  if (currentMode === 'stamp') {
    placeStamp(p.x, p.y);
    return;
  }
  if (currentMode === 'eraser') {
    playEraser();
  }
  /* Dot on tap */
  ctx.save();
  ctx.beginPath();
  if (currentMode === 'eraser') {
    ctx.globalCompositeOperation = 'source-over';
    ctx.fillStyle = '#ffffff';
  } else {
    ctx.fillStyle = currentMode === 'magic' ? magicColor() : currentColor;
  }
  ctx.arc(p.x, p.y, (currentMode === 'eraser' ? brushSize * 1.5 : brushSize) / 2, 0, Math.PI*2);
  ctx.fill();
  ctx.restore();
}

function onDraw(e) {
  if (!isDrawing) return;
  e.preventDefault();
  if (currentMode === 'stamp') return;

  var p   = getPos(e);
  var now = Date.now();

  ctx.save();
  ctx.beginPath();
  ctx.moveTo(lastX, lastY);
  ctx.lineTo(p.x, p.y);
  ctx.lineCap  = 'round';
  ctx.lineJoin = 'round';

  if (currentMode === 'eraser') {
    ctx.globalCompositeOperation = 'source-over';
    ctx.strokeStyle = '#ffffff';
    ctx.lineWidth   = brushSize * 2.2;
  } else {
    var col = currentMode === 'magic' ? magicColor() : currentColor;
    ctx.globalCompositeOperation = 'source-over';
    ctx.strokeStyle = col;
    ctx.lineWidth   = brushSize;

    var rate = currentMode === 'magic' ? 0.55 : 0.18;
    if (Math.random() < rate) {
      fxSparkle(p.x, p.y, col, currentMode === 'magic' ? 3 : 1);
    }
    if (now - brushThrottle > 95) {
      brushThrottle = now;
      if (currentMode === 'magic') playMagic();
      else playBrush();
    }
  }
  ctx.stroke();
  ctx.restore();

  if (currentMode === 'magic') rainbowHue = (rainbowHue + 2.5) % 360;
  lastX = p.x; lastY = p.y;
}

function endDraw() { isDrawing = false; }

canvas.addEventListener('mousedown',  startDraw);
canvas.addEventListener('mousemove',  onDraw);
canvas.addEventListener('mouseup',    endDraw);
canvas.addEventListener('mouseleave', endDraw);
canvas.addEventListener('touchstart', startDraw, {passive:false});
canvas.addEventListener('touchmove',  onDraw,    {passive:false});
canvas.addEventListener('touchend',   endDraw);

function magicColor() {
  return 'hsl(' + rainbowHue + ',90%,50%)';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   10. STAMP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function placeStamp(x, y) {
  var sz = Math.max(26, brushSize * 2.2);
  ctx.save();
  ctx.font          = sz + 'px serif';
  ctx.textAlign     = 'center';
  ctx.textBaseline  = 'middle';
  ctx.translate(x, y);
  ctx.rotate((Math.random() - 0.5) * 0.55);
  ctx.fillText(selectedStamp, 0, 0);
  ctx.restore();
  playStamp();
  fxSparkle(x, y, currentColor, 3);
  bounce(btnStamp);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   11. FX CANVAS â€” Particles (canvas-only, no DOM)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var particles = [];

function fxSparkle(x, y, color, count) {
  count = count || 1;
  for (var i = 0; i < count; i++) {
    var angle = Math.random() * Math.PI * 2;
    var speed = (2 + Math.random() * 5) * (count > 1 ? 1.4 : 1);
    particles.push({
      x: x, y: y, color: color,
      vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed,
      r: 2.5 + Math.random() * 3.5,
      life: 1.0, decay: 0.048 + Math.random() * 0.04,
      type: 'star'
    });
  }
}

function launchConfetti() {
  var cw = fxCvs.width;
  for (var i = 0; i < 130; i++) {
    var hue = Math.random() * 360;
    particles.push({
      x: Math.random() * cw, y: -10 - Math.random() * 80,
      color: 'hsl(' + hue + ',80%,58%)',
      vx: (Math.random() - 0.5) * 4,
      vy: 2 + Math.random() * 4.5,
      r: 5 + Math.random() * 5,
      life: 1.0, decay: 0.006 + Math.random() * 0.007,
      rot: Math.random() * Math.PI * 2,
      rotV: (Math.random() - 0.5) * 0.18,
      w: 6 + Math.random() * 6, h: 3 + Math.random() * 3,
      type: 'confetti'
    });
  }
}

function fxLoop() {
  fxCtx.clearRect(0, 0, fxCvs.width, fxCvs.height);
  for (var i = particles.length - 1; i >= 0; i--) {
    var p = particles[i];
    p.life -= p.decay;
    if (p.life <= 0) { particles.splice(i, 1); continue; }
    p.x += p.vx; p.y += p.vy;

    fxCtx.save();
    fxCtx.globalAlpha = Math.max(0, p.life);

    if (p.type === 'confetti') {
      p.rot += p.rotV;
      p.vy  += 0.11;
      fxCtx.translate(p.x, p.y);
      fxCtx.rotate(p.rot);
      fxCtx.fillStyle = p.color;
      fxCtx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
    } else {
      fxCtx.translate(p.x, p.y);
      fxCtx.fillStyle   = p.color;
      fxCtx.shadowColor = p.color;
      fxCtx.shadowBlur  = p.r * 2.5;
      drawStar(fxCtx, 0, 0, 4, p.r, p.r * 0.42);
    }
    fxCtx.restore();
  }
  requestAnimationFrame(fxLoop);
}
fxLoop();

function drawStar(c, x, y, pts, outer, inner) {
  c.beginPath();
  for (var i = 0; i < pts * 2; i++) {
    var r = i % 2 === 0 ? outer : inner;
    var a = (i / pts) * Math.PI - Math.PI / 2;
    if (i === 0) c.moveTo(x + Math.cos(a)*r, y + Math.sin(a)*r);
    else         c.lineTo(x + Math.cos(a)*r, y + Math.sin(a)*r);
  }
  c.closePath();
  c.fill();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   12. EMOTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.querySelectorAll('.emotion-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    var c = btn.dataset.color;
    pickColor(c, null);
    for (var i = 0; i < 14; i++) {
      fxSparkle(
        canvas.width/2  + (Math.random()-0.5)*300,
        canvas.height/2 + (Math.random()-0.5)*200,
        c, 2
      );
    }
    playSuccess();
    toast(btn.textContent + ' ' + btn.dataset.label + '! Harika renk seÃ§ildi ğŸ¨');
    bounce(btn);
  });
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   13. SAVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function saveImage() {
  /* Flatten onto white */
  var out = document.createElement('canvas');
  out.width  = canvas.width;
  out.height = canvas.height;
  var oc = out.getContext('2d');
  oc.fillStyle = '#ffffff';
  oc.fillRect(0, 0, out.width, out.height);
  oc.drawImage(canvas, 0, 0);

  var a      = document.createElement('a');
  a.download = 'sihirli-cizim-' + Date.now() + '.png';
  a.href     = out.toDataURL('image/png');
  a.click();
  playSuccess();
  launchConfetti();
  toast('ğŸ’¾ Åaheser kaydedildi! Bravo! ğŸŒŸ');
  bounce(document.getElementById('save-btn'));
}
document.getElementById('save-btn').addEventListener('click', saveImage);
document.getElementById('save-btn-float').addEventListener('click', saveImage);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   14. TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var toastT  = null;
var toastEl = document.getElementById('toast');
function toast(msg) {
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  clearTimeout(toastT);
  toastT = setTimeout(function(){ toastEl.classList.remove('show'); }, 2600);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   15. BOUNCE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function bounce(el) {
  el.classList.remove('bounce');
  void el.offsetWidth; // force reflow
  el.classList.add('bounce');
  el.addEventListener('animationend', function(){
    el.classList.remove('bounce');
  }, { once: true });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   16. INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* White canvas already set in resizeCanvas() */
/* Block scroll/zoom only on the canvas area â€” side panels stay scrollable */
var canvasWrapper = document.getElementById('canvas-wrapper');
canvasWrapper.addEventListener('touchmove', function(e){ e.preventDefault(); }, {passive:false});
document.addEventListener('gesturestart',   function(e){ e.preventDefault(); });

/* Let panel touch events bubble freely (do NOT stop them) */
var leftPanel  = document.getElementById('left-panel');
var rightPanel = document.getElementById('right-panel');
[leftPanel, rightPanel].forEach(function(panel){
  panel.addEventListener('touchstart', function(e){ e.stopPropagation(); }, {passive:true});
  panel.addEventListener('touchmove',  function(e){ e.stopPropagation(); }, {passive:true});
});

setTimeout(function(){ toast('âœ¨ Sihirli AtÃ¶lyeye HoÅŸ Geldin! ğŸ¨'); }, 700);
</script>
</body>
</html>